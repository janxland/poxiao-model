{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\n/**\n * tdesign v1.9.0\n * (c) 2024 tdesign\n * @license MIT\n */\n\nimport { ref, createVNode, watch } from 'vue';\nimport '../adapt.mjs';\nimport TreeItem from '../tree-item.mjs';\nimport useTreeEvents from './useTreeEvents.mjs';\nimport { privateKey } from '../../_common/js/tree/tree-node.mjs';\nimport '../../utils/withInstall.mjs';\nimport '../../hooks/useVModel.mjs';\nimport '../../_chunks/dep-bd7cd061.mjs';\nimport '../../_chunks/dep-cb814df4.mjs';\nimport '../../_chunks/dep-96484611.mjs';\nimport '../../_chunks/dep-67e59a11.mjs';\nimport '../../_chunks/dep-cd533155.mjs';\nimport '../../_chunks/dep-8dbc9855.mjs';\nimport '../../_chunks/dep-ab439391.mjs';\nimport '../../_chunks/dep-60d62610.mjs';\nimport '../../_chunks/dep-10024af3.mjs';\nimport '../../_chunks/dep-2adf18a2.mjs';\nimport '../../hooks/useDefaultValue.mjs';\nimport 'tdesign-icons-vue-next';\nimport '../../checkbox/index.mjs';\nimport '../../checkbox/checkbox.mjs';\nimport '../../_chunks/dep-b089fa1f.mjs';\nimport '../../_chunks/dep-8e411f1c.mjs';\nimport '../../_chunks/dep-7deaa3b9.mjs';\nimport '../../checkbox/props.mjs';\nimport '../../hooks/useRipple.mjs';\nimport '../../hooks/useKeepAnimation.mjs';\nimport '../../hooks/useConfig.mjs';\nimport '../../config-provider/useConfig.mjs';\nimport '../../_chunks/dep-66473aa9.mjs';\nimport '../../_chunks/dep-715774e0.mjs';\nimport '../../_chunks/dep-5a5a1764.mjs';\nimport '../../_chunks/dep-37e3e644.mjs';\nimport '../../_chunks/dep-31dc0415.mjs';\nimport '../../_chunks/dep-e5142249.mjs';\nimport '../../_chunks/dep-c4f80cb4.mjs';\nimport '../../_chunks/dep-996b4900.mjs';\nimport '../../_chunks/dep-3108c312.mjs';\nimport '../../_chunks/dep-93498383.mjs';\nimport '../../_chunks/dep-36582a92.mjs';\nimport '../../_chunks/dep-a2db6df1.mjs';\nimport '../../_chunks/dep-0f89a1dd.mjs';\nimport '../../_chunks/dep-d4da440a.mjs';\nimport '../../_chunks/dep-013382c3.mjs';\nimport '../../_chunks/dep-ca764006.mjs';\nimport '../../_chunks/dep-2ee9d497.mjs';\nimport '../../_chunks/dep-c545db54.mjs';\nimport '../../_chunks/dep-3f15cb30.mjs';\nimport '../../_chunks/dep-fd2b6c64.mjs';\nimport '../../_chunks/dep-30b3f256.mjs';\nimport '../../_chunks/dep-b3734774.mjs';\nimport '../../_chunks/dep-a4a3ac25.mjs';\nimport '../../_chunks/dep-6861d388.mjs';\nimport '../../_chunks/dep-396d852b.mjs';\nimport '../../_chunks/dep-8a3fd140.mjs';\nimport '../../_chunks/dep-5db0da5c.mjs';\nimport '../../_common/js/global-config/default-config.mjs';\nimport '../../_common/js/global-config/locale/zh_CN.mjs';\nimport '../../_chunks/dep-bf19d9ba.mjs';\nimport '../../_chunks/dep-6963a882.mjs';\nimport '../../config-provider/type.mjs';\nimport '../../utils/set-style.mjs';\nimport '../../hooks/tnode.mjs';\nimport '../../_chunks/dep-f8909853.mjs';\nimport '../../_chunks/dep-d00e2e04.mjs';\nimport '../../_chunks/dep-ec2f76cc.mjs';\nimport '../../utils/render-tnode.mjs';\nimport '../../_chunks/dep-60ee423b.mjs';\nimport '../../checkbox/constants.mjs';\nimport '../../checkbox/hooks/useCheckboxLazyLoad.mjs';\nimport '../../_common/js/utils/observe.mjs';\nimport '../../checkbox/hooks/useKeyboardEvent.mjs';\nimport '../../_common/js/common.mjs';\nimport '../../hooks/useDisabled.mjs';\nimport '../../_chunks/dep-03dfef8f.mjs';\nimport '../../checkbox/group.mjs';\nimport '../../_chunks/dep-b15588b0.mjs';\nimport '../../_chunks/dep-c628112b.mjs';\nimport '../../_chunks/dep-1aab510a.mjs';\nimport '../../_chunks/dep-931fe368.mjs';\nimport '../../_chunks/dep-ac561548.mjs';\nimport '../../checkbox/checkbox-group-props.mjs';\nimport '../../hooks/slot.mjs';\nimport './style/css.mjs';\nimport '../../checkbox/type.mjs';\nimport '../../loading/index.mjs';\nimport '../../_chunks/dep-503b7515.mjs';\nimport '../../_chunks/dep-e32ac680.mjs';\nimport '../../_chunks/dep-230c1b47.mjs';\nimport '../../_chunks/dep-cedc2818.mjs';\nimport '../../_chunks/dep-8dae3bca.mjs';\nimport '../../_chunks/dep-41db3bc9.mjs';\nimport '../../_chunks/dep-da57e0cf.mjs';\nimport '../../loading/plugin.mjs';\nimport '../../loading/loading.mjs';\nimport '../../loading/icon/gradient.mjs';\nimport '../../_common/js/loading/circle-adapter.mjs';\nimport '../../_common/js/utils/set-style.mjs';\nimport '../../_common/js/utils/helper.mjs';\nimport '../../_chunks/dep-807e1747.mjs';\nimport '../../_chunks/dep-413fbf03.mjs';\nimport '../../_chunks/dep-0e4de31a.mjs';\nimport '../../utils/dom.mjs';\nimport '../../utils/easing.mjs';\nimport '../../loading/props.mjs';\nimport '../../hooks/useTeleport.mjs';\nimport '../../loading/type.mjs';\nimport '../../hooks/useGlobalIcon.mjs';\nimport '../../hooks/useLazyLoad.mjs';\nimport '../../hooks/useVirtualScrollNew.mjs';\nimport '../../hooks/useResizeObserver.mjs';\nimport '../../_chunks/dep-cede586b.mjs';\nimport '../../_chunks/dep-665d45b4.mjs';\nimport '../../_chunks/dep-27be073b.mjs';\nimport '../../_chunks/dep-f14cdac0.mjs';\nimport '../../_chunks/dep-12bcaf4a.mjs';\nimport '../../_chunks/dep-d0177ed3.mjs';\nimport '../../_chunks/dep-cd711cee.mjs';\nimport '../../_common/js/tree/tree-node-model.mjs';\nimport '../../_chunks/dep-8fdb2da0.mjs';\nimport '../../_chunks/dep-d7c36095.mjs';\nimport '../../_chunks/dep-4481f632.mjs';\nimport '../../_common/js/log/log.mjs';\nimport '../../_common/js/log/index.mjs';\nimport './useItemState.mjs';\nimport './useTreeItem.mjs';\nimport './useItemEvents.mjs';\nimport './useRenderIcon.mjs';\nimport '../util.mjs';\nimport './useRenderLabel.mjs';\nimport './useRenderLine.mjs';\nimport './useRenderOperations.mjs';\nimport './useDraggable.mjs';\nimport './useTreeAction.mjs';\nfunction useTreeNodes(state) {\n  var store = state.store,\n    scope = state.scope,\n    allNodes = state.allNodes,\n    nodes = state.nodes,\n    virtualConfig = state.virtualConfig;\n  var _useTreeEvents = useTreeEvents(state),\n    handleClick = _useTreeEvents.handleClick,\n    handleChange = _useTreeEvents.handleChange;\n  var nodesEmpty = ref(false);\n  var cacheMap = /* @__PURE__ */new Map();\n  var refresh = function refresh() {\n    allNodes.value = store.getNodes();\n  };\n  var refreshVisibleNodes = function refreshVisibleNodes() {\n    var isVirtual = virtualConfig === null || virtualConfig === void 0 ? void 0 : virtualConfig.isVirtualScroll.value;\n    if (isVirtual) return;\n    var list = [];\n    var hasVisibleNode = false;\n    allNodes.value.forEach(function (node) {\n      if (node.visible) {\n        hasVisibleNode = true;\n        cacheMap.set(node.value, node.value);\n      }\n      if (cacheMap.has(node.value)) {\n        list.push(node);\n      }\n    });\n    cacheMap.forEach(function (value) {\n      if (!store.getNode(value)) {\n        cacheMap[\"delete\"](value);\n      }\n    });\n    nodes.value = list;\n    nodesEmpty.value = !hasVisibleNode;\n  };\n  var refreshVirtualNodes = function refreshVirtualNodes() {\n    var isVirtual = virtualConfig === null || virtualConfig === void 0 ? void 0 : virtualConfig.isVirtualScroll.value;\n    if (!isVirtual) return;\n    var list = virtualConfig.visibleData.value;\n    nodes.value = list;\n    nodesEmpty.value = list.length <= 0;\n  };\n  var renderItem = function renderItem(h, node, index, stateId) {\n    var rowIndex = node.VIRTUAL_SCROLL_INDEX || index;\n    var nodeUniqueId = node[privateKey];\n    var treeItem = createVNode(TreeItem, {\n      \"key\": nodeUniqueId,\n      \"rowIndex\": rowIndex,\n      \"stateId\": stateId,\n      \"itemKey\": nodeUniqueId,\n      \"treeScope\": scope,\n      \"onClick\": handleClick,\n      \"onChange\": handleChange\n    }, null);\n    return treeItem;\n  };\n  var renderTreeNodes = function renderTreeNodes(h) {\n    var stateId = \"render-\".concat(new Date().getTime());\n    var treeNodeViews = nodes.value.map(function (node, index) {\n      return renderItem(h, node, index, stateId);\n    });\n    return treeNodeViews;\n  };\n  watch(allNodes, refreshVisibleNodes);\n  watch(virtualConfig.visibleData, refreshVirtualNodes);\n  refresh();\n  refreshVisibleNodes();\n  refreshVirtualNodes();\n  store.emitter.on(\"update\", refresh);\n  return {\n    nodesEmpty: nodesEmpty,\n    renderTreeNodes: renderTreeNodes\n  };\n}\nexport { useTreeNodes as default };","map":{"version":3,"names":["useTreeNodes","state","store","scope","allNodes","nodes","virtualConfig","_useTreeEvents","useTreeEvents","handleClick","handleChange","nodesEmpty","ref","cacheMap","Map","refresh","value","getNodes","refreshVisibleNodes","isVirtual","isVirtualScroll","list","hasVisibleNode","forEach","node","visible","set","has","push","getNode","refreshVirtualNodes","visibleData","length","renderItem","h","index","stateId","rowIndex","VIRTUAL_SCROLL_INDEX","nodeUniqueId","privateKey","treeItem","createVNode","TreeItem","renderTreeNodes","concat","Date","getTime","treeNodeViews","map","watch","emitter","on"],"sources":["../../../src/tree/hooks/useTreeNodes.tsx"],"sourcesContent":["import { ref, watch, TypeCreateElement, privateKey, TypeVNode } from '../adapt';\nimport { TypeTreeRow, TypeTreeNode, TypeTreeState } from '../tree-types';\nimport TreeItem from '../tree-item';\nimport useTreeEvents from './useTreeEvents';\n\n// tree 节点列表渲染\nexport default function useTreeNodes(state: TypeTreeState) {\n  const { store, scope, allNodes, nodes, virtualConfig } = state;\n  const { handleClick, handleChange } = useTreeEvents(state);\n  const nodesEmpty = ref(false);\n  // 用于存储已呈现节点的缓存\n  const cacheMap = new Map();\n\n  const refresh = () => {\n    allNodes.value = store.getNodes();\n  };\n\n  const refreshVisibleNodes = () => {\n    const isVirtual = virtualConfig?.isVirtualScroll.value;\n    if (isVirtual) return;\n    // 非虚拟滚动，渲染可视节点\n    const list: TypeTreeNode[] = [];\n    // 非虚拟滚动，缓存曾经展示过的节点\n    let hasVisibleNode = false;\n    allNodes.value.forEach((node: TypeTreeNode) => {\n      if (node.visible) {\n        // 曾经展示过的节点加入缓存，避免再次创建\n        hasVisibleNode = true;\n        cacheMap.set(node.value, node.value);\n      }\n      if (cacheMap.has(node.value)) {\n        // 创建的节点是缓存的节点\n        list.push(node);\n      }\n    });\n    cacheMap.forEach((value) => {\n      // 在缓存中清理结构变化后不存在的节点\n      if (!store.getNode(value)) {\n        cacheMap.delete(value);\n      }\n    });\n    // 渲染为平铺列表\n    nodes.value = list;\n    nodesEmpty.value = !hasVisibleNode;\n  };\n\n  const refreshVirtualNodes = () => {\n    const isVirtual = virtualConfig?.isVirtualScroll.value;\n    if (!isVirtual) return;\n    // 虚拟滚动只渲染可见节点\n    const list = virtualConfig.visibleData.value;\n    nodes.value = list;\n    nodesEmpty.value = list.length <= 0;\n  };\n\n  // 创建单个 tree 节点\n  const renderItem = (h: TypeCreateElement, node: TypeTreeRow, index: number, stateId: string) => {\n    const rowIndex = node.VIRTUAL_SCROLL_INDEX || index;\n    const nodeUniqueId = node[privateKey];\n    // vue3 中，不使用动画时，传递 node, 或者单纯传递 itemKey 无法触发 treeItem 的 render 方法\n    // 考虑到有必要对所有节点状态更新，所以添加 stateId 属性，专门用于触发 treeItem 的 render 方法\n    // 使用动画时，transition group 触发了所有节点的 render 方法，回头可以研究看下更合适的方案\n    // 未来也可以根据节点数据的具体更新状态，来决定节点更新与否\n    // 考虑到 value 值有冲突可能，所以使用 privateKey 来作为节点标记\n    const treeItem = (\n      <TreeItem\n        key={nodeUniqueId}\n        rowIndex={rowIndex}\n        stateId={stateId}\n        itemKey={nodeUniqueId}\n        treeScope={scope}\n        onClick={handleClick}\n        onChange={handleChange}\n      />\n    );\n    return treeItem;\n  };\n\n  const renderTreeNodes = (h: TypeCreateElement) => {\n    const stateId = `render-${new Date().getTime()}`;\n    const treeNodeViews: TypeVNode[] = nodes.value.map((node: TypeTreeNode, index) =>\n      renderItem(h, node, index, stateId),\n    );\n    return treeNodeViews;\n  };\n\n  watch(allNodes, refreshVisibleNodes);\n  watch(virtualConfig.visibleData, refreshVirtualNodes);\n\n  refresh();\n  refreshVisibleNodes();\n  refreshVirtualNodes();\n  store.emitter.on('update', refresh);\n\n  return {\n    nodesEmpty,\n    renderTreeNodes,\n  };\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}