{"ast":null,"code":"/**\n * tdesign v1.9.3\n * (c) 2024 tdesign\n * @license MIT\n */\n\nimport { ref, watch } from 'vue';\nimport { usePrefixClass } from '../../hooks/useConfig.mjs';\nimport { getNewMultipleValue } from '../helper.mjs';\nimport '../../config-provider/useConfig.mjs';\nimport '../../_chunks/dep-6e7655db.mjs';\nimport '../../_chunks/dep-437d10c6.mjs';\nimport '../../_chunks/dep-6ad32365.mjs';\nimport '../../_chunks/dep-d33c5d88.mjs';\nimport '../../_chunks/dep-62ad5a36.mjs';\nimport '../../_chunks/dep-f76ec896.mjs';\nimport '../../_chunks/dep-db7324ec.mjs';\nimport '../../_chunks/dep-d090226f.mjs';\nimport '../../_chunks/dep-c31faaef.mjs';\nimport '../../_chunks/dep-5f15268c.mjs';\nimport '../../_chunks/dep-c70e40ae.mjs';\nimport '../../_chunks/dep-4382b808.mjs';\nimport '../../_chunks/dep-0894e3ae.mjs';\nimport '../../_chunks/dep-0ced8e2e.mjs';\nimport '../../_chunks/dep-fb9941c5.mjs';\nimport '../../_chunks/dep-75628739.mjs';\nimport '../../_chunks/dep-1494b54a.mjs';\nimport '../../_chunks/dep-0e5b2b76.mjs';\nimport '../../_chunks/dep-f3a27c4c.mjs';\nimport '../../_chunks/dep-e3204123.mjs';\nimport '../../_chunks/dep-10c900d8.mjs';\nimport '../../_chunks/dep-1c5d24dd.mjs';\nimport '../../_chunks/dep-b6946d89.mjs';\nimport '../../_chunks/dep-6ea85de8.mjs';\nimport '../../_chunks/dep-92ce9c6c.mjs';\nimport '../../_chunks/dep-3b84887f.mjs';\nimport '../../_chunks/dep-5d7be5c6.mjs';\nimport '../../_chunks/dep-0223e29d.mjs';\nimport '../../_chunks/dep-3d61d8a6.mjs';\nimport '../../_chunks/dep-88c02450.mjs';\nimport '../../_chunks/dep-f7067d3d.mjs';\nimport '../../_chunks/dep-cd1b7f96.mjs';\nimport '../../_chunks/dep-eea784eb.mjs';\nimport '../../_common/js/global-config/default-config.mjs';\nimport '../../_common/js/global-config/locale/zh_CN.mjs';\nimport '../../_chunks/dep-0c808c2e.mjs';\nimport '../../_chunks/dep-4c103c66.mjs';\nimport '../../config-provider/type.mjs';\nfunction useKeyboardControl(_ref) {\n  var displayOptions = _ref.displayOptions,\n    optionsList = _ref.optionsList,\n    innerPopupVisible = _ref.innerPopupVisible,\n    setInnerPopupVisible = _ref.setInnerPopupVisible,\n    selectPanelRef = _ref.selectPanelRef,\n    isFilterable = _ref.isFilterable,\n    getSelectedOptions = _ref.getSelectedOptions,\n    setInnerValue = _ref.setInnerValue,\n    innerValue = _ref.innerValue,\n    popupContentRef = _ref.popupContentRef,\n    multiple = _ref.multiple,\n    max = _ref.max;\n  var hoverIndex = ref(-1);\n  var filteredOptions = ref([]);\n  var virtualFilteredOptions = ref([]);\n  var classPrefix = usePrefixClass();\n  var handleKeyDown = function handleKeyDown(e) {\n    var _optionsList$value$ne, _optionsList$value$ne2;\n    var optionsListLength = displayOptions.value.length;\n    var newIndex = hoverIndex.value;\n    switch (e.code) {\n      case \"ArrowUp\":\n        e.preventDefault();\n        if (hoverIndex.value === -1) {\n          newIndex = 0;\n        } else if (hoverIndex.value === 0 || hoverIndex.value > displayOptions.value.length - 1) {\n          newIndex = optionsListLength - 1;\n        } else {\n          newIndex--;\n        }\n        if ((_optionsList$value$ne = optionsList.value[newIndex]) !== null && _optionsList$value$ne !== void 0 && _optionsList$value$ne.disabled) {\n          newIndex--;\n        }\n        hoverIndex.value = newIndex;\n        break;\n      case \"ArrowDown\":\n        e.preventDefault();\n        if (hoverIndex.value === -1 || hoverIndex.value >= optionsListLength - 1) {\n          newIndex = 0;\n        } else {\n          newIndex++;\n        }\n        if ((_optionsList$value$ne2 = optionsList.value[newIndex]) !== null && _optionsList$value$ne2 !== void 0 && _optionsList$value$ne2.disabled) {\n          newIndex++;\n        }\n        hoverIndex.value = newIndex;\n        break;\n      case \"Enter\":\n        if (hoverIndex.value === -1) break;\n        var finalOptions = selectPanelRef.value.isVirtual && isFilterable.value && virtualFilteredOptions.value.length ? virtualFilteredOptions.value : filteredOptions.value;\n        if (!finalOptions.length) finalOptions = optionsList.value;\n        if (!innerPopupVisible.value) {\n          setInnerPopupVisible(true, {\n            e: e\n          });\n          break;\n        }\n        if (!multiple) {\n          var selectedOptions = getSelectedOptions(finalOptions[hoverIndex.value].value);\n          setInnerValue(finalOptions[hoverIndex.value].value, {\n            option: selectedOptions === null || selectedOptions === void 0 ? void 0 : selectedOptions[0],\n            selectedOptions: getSelectedOptions(finalOptions[hoverIndex.value].value),\n            trigger: \"check\",\n            e: e\n          });\n          setInnerPopupVisible(false, {\n            e: e\n          });\n        } else {\n          var _finalOptions$hoverIn;\n          if (hoverIndex.value === -1) return;\n          var optionValue = (_finalOptions$hoverIn = finalOptions[hoverIndex.value]) === null || _finalOptions$hoverIn === void 0 ? void 0 : _finalOptions$hoverIn.value;\n          if (!optionValue) return;\n          var newValue = getNewMultipleValue(innerValue.value, optionValue);\n          if (max > 0 && newValue.value.length > max) return;\n          var _selectedOptions = getSelectedOptions(newValue.value);\n          setInnerValue(newValue.value, {\n            option: _selectedOptions.find(function (v) {\n              return v.value == optionValue;\n            }),\n            selectedOptions: _selectedOptions,\n            trigger: newValue.isCheck ? \"check\" : \"uncheck\",\n            e: e\n          });\n        }\n        break;\n      case \"Escape\":\n        setInnerPopupVisible(false, {\n          e: e\n        });\n        break;\n    }\n  };\n  watch(innerPopupVisible, function (value) {\n    if (value) {\n      hoverIndex.value = -1;\n      virtualFilteredOptions.value = [];\n      filteredOptions.value = [];\n    }\n  });\n  watch(hoverIndex, function (index) {\n    var _selectPanelRef$value;\n    var optionHeight = (_selectPanelRef$value = selectPanelRef.value) === null || _selectPanelRef$value === void 0 || (_selectPanelRef$value = _selectPanelRef$value.innerRef) === null || _selectPanelRef$value === void 0 ? void 0 : _selectPanelRef$value.querySelector(\".\".concat(classPrefix.value, \"-select-option\")).clientHeight;\n    var scrollHeight = optionHeight * index;\n    popupContentRef.value.scrollTo({\n      top: scrollHeight,\n      behavior: \"smooth\"\n    });\n  });\n  return {\n    hoverIndex: hoverIndex,\n    handleKeyDown: handleKeyDown,\n    virtualFilteredOptions: virtualFilteredOptions,\n    filteredOptions: filteredOptions\n  };\n}\nexport { useKeyboardControl as default };","map":{"version":3,"names":["useKeyboardControl","_ref","displayOptions","optionsList","innerPopupVisible","setInnerPopupVisible","selectPanelRef","isFilterable","getSelectedOptions","setInnerValue","innerValue","popupContentRef","multiple","max","hoverIndex","ref","filteredOptions","virtualFilteredOptions","classPrefix","usePrefixClass","handleKeyDown","e","_optionsList$value$ne","_optionsList$value$ne2","optionsListLength","value","length","newIndex","code","preventDefault","disabled","finalOptions","isVirtual","selectedOptions","option","trigger","_finalOptions$hoverIn","optionValue","newValue","getNewMultipleValue","_selectedOptions","find","v","isCheck","watch","index","_selectPanelRef$value","optionHeight","innerRef","querySelector","concat","clientHeight","scrollHeight","scrollTo","top","behavior"],"sources":["../../../src/select/hooks/useKeyboardControl.ts"],"sourcesContent":["import { ref, watch, ComputedRef, Ref } from 'vue';\nimport { usePrefixClass } from '../../hooks/useConfig';\n\nimport { getNewMultipleValue } from '../helper';\n\nimport type { SelectOption, TdOptionProps, SelectValue } from '../type';\nimport type { ChangeHandler } from '../../hooks/useVModel';\nimport type { PopupVisibleChangeContext } from '../../popup';\n\nexport type useKeyboardControlType = {\n  displayOptions: ComputedRef<SelectOption[]>;\n  optionsList: ComputedRef<TdOptionProps[]>;\n  innerPopupVisible: Ref<boolean>;\n  setInnerPopupVisible: ChangeHandler<boolean, [context: PopupVisibleChangeContext]>;\n  selectPanelRef: Ref<{ isVirtual: boolean; innerRef: HTMLDivElement }>;\n  isFilterable: ComputedRef<boolean>;\n  getSelectedOptions: (selectValue?: SelectValue[] | SelectValue) => TdOptionProps[];\n  setInnerValue: Function;\n  innerValue: Ref<SelectValue[]>;\n  popupContentRef: ComputedRef<HTMLElement>;\n  multiple: boolean;\n  max: number;\n};\n\n// 统一处理键盘控制的hooks\nexport default function useKeyboardControl({\n  displayOptions,\n  optionsList,\n  innerPopupVisible,\n  setInnerPopupVisible,\n  selectPanelRef,\n  isFilterable,\n  getSelectedOptions,\n  setInnerValue,\n  innerValue,\n  popupContentRef,\n  multiple,\n  max,\n}: useKeyboardControlType) {\n  const hoverIndex = ref(-1);\n  const filteredOptions = ref([]); // 处理普通场景选项过滤键盘选中的问题\n  const virtualFilteredOptions = ref([]); // 处理虚拟滚动下选项过滤通过键盘选择的问题\n  const classPrefix = usePrefixClass();\n  const handleKeyDown = (e: KeyboardEvent) => {\n    const optionsListLength = displayOptions.value.length;\n    let newIndex = hoverIndex.value;\n    switch (e.code) {\n      case 'ArrowUp':\n        e.preventDefault();\n        if (hoverIndex.value === -1) {\n          newIndex = 0;\n        } else if (hoverIndex.value === 0 || hoverIndex.value > displayOptions.value.length - 1) {\n          newIndex = optionsListLength - 1;\n        } else {\n          newIndex--;\n        }\n        if (optionsList.value[newIndex]?.disabled) {\n          newIndex--;\n        }\n        hoverIndex.value = newIndex;\n        break;\n      case 'ArrowDown':\n        e.preventDefault();\n\n        if (hoverIndex.value === -1 || hoverIndex.value >= optionsListLength - 1) {\n          newIndex = 0;\n        } else {\n          newIndex++;\n        }\n        if (optionsList.value[newIndex]?.disabled) {\n          newIndex++;\n        }\n        hoverIndex.value = newIndex;\n        break;\n      case 'Enter':\n        if (hoverIndex.value === -1) break;\n\n        let finalOptions =\n          selectPanelRef.value.isVirtual && isFilterable.value && virtualFilteredOptions.value.length\n            ? virtualFilteredOptions.value\n            : filteredOptions.value;\n\n        if (!finalOptions.length) finalOptions = optionsList.value;\n        if (!innerPopupVisible.value) {\n          setInnerPopupVisible(true, { e });\n          break;\n        }\n\n        if (!multiple) {\n          const selectedOptions = getSelectedOptions(finalOptions[hoverIndex.value].value);\n          setInnerValue(finalOptions[hoverIndex.value].value, {\n            option: selectedOptions?.[0],\n            selectedOptions: getSelectedOptions(finalOptions[hoverIndex.value].value),\n            trigger: 'check',\n            e,\n          });\n          setInnerPopupVisible(false, { e });\n        } else {\n          if (hoverIndex.value === -1) return;\n          const optionValue = finalOptions[hoverIndex.value]?.value;\n\n          if (!optionValue) return;\n          const newValue = getNewMultipleValue(innerValue.value, optionValue);\n\n          if (max > 0 && newValue.value.length > max) return; // 如果已选达到最大值 则不处理\n          const selectedOptions = getSelectedOptions(newValue.value);\n          setInnerValue(newValue.value, {\n            option: selectedOptions.find((v) => v.value == optionValue),\n            selectedOptions,\n            trigger: newValue.isCheck ? 'check' : 'uncheck',\n            e,\n          });\n        }\n        break;\n      case 'Escape':\n        setInnerPopupVisible(false, { e });\n        break;\n    }\n  };\n\n  watch(innerPopupVisible, (value) => {\n    if (value) {\n      // 展开重新恢复初始值\n      hoverIndex.value = -1;\n      virtualFilteredOptions.value = [];\n      filteredOptions.value = [];\n    }\n  });\n\n  // 处理键盘操作滚动 超出视图时继续自动滚动到键盘所在元素\n  watch(hoverIndex, (index) => {\n    const optionHeight = selectPanelRef.value?.innerRef?.querySelector(\n      `.${classPrefix.value}-select-option`,\n    ).clientHeight;\n\n    const scrollHeight = optionHeight * index;\n\n    popupContentRef.value.scrollTo({\n      top: scrollHeight,\n      behavior: 'smooth',\n    });\n  });\n\n  return {\n    hoverIndex,\n    handleKeyDown,\n    virtualFilteredOptions,\n    filteredOptions,\n  };\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyBA,SAAwBA,kBAAmBA,CAAAC,IAAA,EAahB;EAAA,IAZzBC,cAAA,GAAAD,IAAA,CAAAC,cAAA;IACAC,WAAA,GAAAF,IAAA,CAAAE,WAAA;IACAC,iBAAA,GAAAH,IAAA,CAAAG,iBAAA;IACAC,oBAAA,GAAAJ,IAAA,CAAAI,oBAAA;IACAC,cAAA,GAAAL,IAAA,CAAAK,cAAA;IACAC,YAAA,GAAAN,IAAA,CAAAM,YAAA;IACAC,kBAAA,GAAAP,IAAA,CAAAO,kBAAA;IACAC,aAAA,GAAAR,IAAA,CAAAQ,aAAA;IACAC,UAAA,GAAAT,IAAA,CAAAS,UAAA;IACAC,eAAA,GAAAV,IAAA,CAAAU,eAAA;IACAC,QAAA,GAAAX,IAAA,CAAAW,QAAA;IACAC,GAAA,GAAAZ,IAAA,CAAAY,GAAA;EAEM,IAAAC,UAAA,GAAaC,GAAA,CAAI,CAAE;EACnB,IAAAC,eAAA,GAAkBD,GAAI,GAAE;EACxB,IAAAE,sBAAA,GAAyBF,GAAI,GAAE;EACrC,IAAMG,WAAA,GAAcC,cAAe;EAC7B,IAAAC,aAAA,GAAgB,SAAhBA,cAAiBC,CAAqB;IAAA,IAAAC,qBAAA,EAAAC,sBAAA;IACpC,IAAAC,iBAAA,GAAoBtB,cAAA,CAAeuB,KAAM,CAAAC,MAAA;IAC/C,IAAIC,QAAA,GAAWb,UAAW,CAAAW,KAAA;IAC1B,QAAQJ,CAAE,CAAAO,IAAA;MACH;QACHP,CAAA,CAAEQ,cAAe;QACb,IAAAf,UAAA,CAAWW,KAAA,KAAU,CAAI;UAChBE,QAAA;QACb,WAAWb,UAAA,CAAWW,KAAU,UAAKX,UAAA,CAAWW,KAAQ,GAAAvB,cAAA,CAAeuB,KAAM,CAAAC,MAAA,GAAS,CAAG;UACvFC,QAAA,GAAWH,iBAAoB;QACjC,CAAO;UACLG,QAAA;QACF;QACI,KAAAL,qBAAA,GAAAnB,WAAA,CAAYsB,KAAM,CAAAE,QAAA,eAAAL,qBAAA,eAAlBA,qBAAA,CAA6BQ,QAAU;UACzCH,QAAA;QACF;QACAb,UAAA,CAAWW,KAAQ,GAAAE,QAAA;QACnB;MACG;QACHN,CAAA,CAAEQ,cAAe;QAEjB,IAAIf,UAAA,CAAWW,KAAU,WAAMX,UAAW,CAAAW,KAAA,IAASD,iBAAA,GAAoB,CAAG;UAC7DG,QAAA;QACb,CAAO;UACLA,QAAA;QACF;QACI,KAAAJ,sBAAA,GAAApB,WAAA,CAAYsB,KAAM,CAAAE,QAAA,eAAAJ,sBAAA,eAAlBA,sBAAA,CAA6BO,QAAU;UACzCH,QAAA;QACF;QACAb,UAAA,CAAWW,KAAQ,GAAAE,QAAA;QACnB;MACG;QACH,IAAIb,UAAA,CAAWW,KAAU,SAAI;QAEzB,IAAAM,YAAA,GACFzB,cAAe,CAAAmB,KAAA,CAAMO,SAAa,IAAAzB,YAAA,CAAakB,KAAS,IAAAR,sBAAA,CAAuBQ,KAAM,CAAAC,MAAA,GACjFT,sBAAuB,CAAAQ,KAAA,GACvBT,eAAgB,CAAAS,KAAA;QAEtB,IAAI,CAACM,YAAa,CAAAL,MAAA,EAAQK,YAAA,GAAe5B,WAAY,CAAAsB,KAAA;QACjD,KAACrB,iBAAA,CAAkBqB,KAAO;UACPpB,oBAAA,OAAM;YAAEgB,CAAA,EAAAA;UAAE,CAAC;UAChC;QACF;QAEA,IAAI,CAACT,QAAU;UACb,IAAMqB,eAAkB,GAAAzB,kBAAA,CAAmBuB,YAAa,CAAAjB,UAAA,CAAWW,KAAA,EAAOA,KAAK;UACjEhB,aAAA,CAAAsB,YAAA,CAAajB,UAAW,CAAAW,KAAA,EAAOA,KAAO;YAClDS,MAAA,EAAQD,eAAkB,KAAlB,QAAAA,eAAkB,uBAAlBA,eAAkB;YAC1BA,eAAiB,EAAAzB,kBAAA,CAAmBuB,YAAa,CAAAjB,UAAA,CAAWW,KAAA,EAAOA,KAAK;YACxEU,OAAS;YACTd,CAAA,EAAAA;UACF,CAAC;UACoBhB,oBAAA,QAAO;YAAEgB,CAAA,EAAAA;UAAE,CAAC;QACnC,CAAO;UAAA,IAAAe,qBAAA;UACL,IAAItB,UAAA,CAAWW,KAAU,SAAI;UACvB,IAAAY,WAAA,IAAAD,qBAAA,GAAcL,YAAa,CAAAjB,UAAA,CAAWW,KAAQ,eAAAW,qBAAA,KAAhC,kBAAAA,qBAAA,CAAgCX,KAAA;UAEpD,IAAI,CAACY,WAAA,EAAa;UAClB,IAAMC,QAAW,GAAAC,mBAAA,CAAoB7B,UAAW,CAAAe,KAAA,EAAOY,WAAW;UAElE,IAAIxB,GAAM,QAAKyB,QAAS,CAAAb,KAAA,CAAMC,MAAS,GAAAb,GAAA,EAAK;UACtC,IAAA2B,gBAAA,GAAkBhC,kBAAmB,CAAA8B,QAAA,CAASb,KAAK;UACzDhB,aAAA,CAAc6B,QAAA,CAASb,KAAO;YAC5BS,MAAA,EAAQM,gBAAgB,CAAAC,IAAA,CAAK,UAACC,CAAM;cAAA,OAAAA,CAAA,CAAEjB,KAAA,IAASY,WAAW;aAAA;YAC1DJ,eAAA,EAAAO,gBAAA;YACAL,OAAA,EAASG,QAAS,CAAAK,OAAA,GAAU,OAAU;YACtCtB,CAAA,EAAAA;UACF,CAAC;QACH;QACA;MACG;QACkBhB,oBAAA,QAAO;UAAEgB,CAAA,EAAAA;QAAE,CAAC;QACjC;IAAA;GAEN;EAEMuB,KAAA,CAAAxC,iBAAA,EAAmB,UAACqB,KAAU;IAClC,IAAIA,KAAO;MAETX,UAAA,CAAWW,KAAQ;MACnBR,sBAAA,CAAuBQ,KAAA,GAAQ,EAAC;MAChCT,eAAA,CAAgBS,KAAA,GAAQ,EAAC;IAC3B;EACF,CAAC;EAGKmB,KAAA,CAAA9B,UAAA,EAAY,UAAC+B,KAAU;IAAA,IAAAC,qBAAA;IACrB,IAAAC,YAAA,IAAAD,qBAAA,GAAexC,cAAe,CAAAmB,KAAA,cAAAqB,qBAAA,gBAAAA,qBAAA,GAAfA,qBAAA,CAAsBE,QAAU,cAAAF,qBAAA,KAAhC,kBAAAA,qBAAA,CAAgCG,aAAA,KAAAC,MAAA,CAC/ChC,WAAY,CAAAO,KAAA,EAClB,kBAAE,CAAA0B,YAAA;IAEF,IAAMC,YAAA,GAAeL,YAAe,GAAAF,KAAA;IAEpClC,eAAA,CAAgBc,KAAA,CAAM4B,QAAS;MAC7BC,GAAK,EAAAF,YAAA;MACLG,QAAU;IACZ,CAAC;EACH,CAAC;EAEM;IACLzC,UAAA,EAAAA,UAAA;IACAM,aAAA,EAAAA,aAAA;IACAH,sBAAA,EAAAA,sBAAA;IACAD,eAAA,EAAAA;GACF;AACF","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}